---
title: "High Speed Coronavirus Visuals"
author: "Francis Britschgi"
Updated on: "5/22/2020"
output: html_document
---
```{r date, include = F}
#install.packages()
update_day = format(Sys.Date(), format="%B %d %Y")
data_day = format(Sys.Date()-2, format="%B %d %Y")
```

*Publication Updated on `r update_day`*

```{r setup, include=F}
setwd("C:/Users/frbrit/Documents")
#install.packages(c("dplyr","zoo","string","plotly","viridis","ggthemes"),repos = "http://cran.us.r-project.org")
library(dplyr)
library(zoo)
library(stringr)
library(plotly)
library(viridis)
library(ggthemes)

x <-"https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-states.csv"
original_COVID19 <- read.csv(x)
COVID19 <- original_COVID19
National <- COVID19 %>%
  group_by(date) %>%
  summarise(deaths=sum(deaths)) %>%
  mutate(state = "-Nationwide-") %>%
  mutate(fips = 0)
COVID19 <- bind_rows(National,COVID19)
colnames(COVID19)[4] <- "FIPS"
CensusData <- read.csv("~/Academy PreWork/COVID Demo/CensusData.csv")
COVID19 <- merge(COVID19,CensusData[,c(4,6,8,9)], 
                 by = "FIPS")

COVID19Final <- COVID19 %>%
  filter(!is.na(FIPS)) %>%
  mutate(date = as.Date(date)) %>%
  group_by(FIPS) %>%
  arrange(FIPS,date) %>%
  mutate(deaths = deaths - lag(deaths,1)) %>%
  mutate(deaths = ifelse(is.na(deaths),0,deaths)) %>%
  mutate(deaths_weekly_average = rollapply(deaths,7,mean,na.rm=T,align='right',fill=NA)) %>%
  mutate(max_deaths = max(deaths, na.rm = T)) %>%
  mutate(max_average_deaths = max(deaths_weekly_average, na.rm = T)) %>%
  mutate(most_recent_date = max(date, na.rm = T)) %>%
  mutate(most_recent_deaths = deaths[date == most_recent_date]) %>%
  mutate(prop_of_maxdeaths = deaths/max_deaths) %>%
  mutate(cumulative_deaths = cumsum(na.omit(deaths))) %>%
  mutate(weekly_average_deaths = rollapply(deaths,7,mean, na.rm=T, align='right', fill=NA)) %>%
  mutate(weekly_average_deaths = ifelse(!is.finite(weekly_average_deaths),NA,round(weekly_average_deaths,0))) %>%
  mutate(FIPS_String = str_pad(FIPS,5,pad="0")) %>%
  mutate(Total_Deaths_2019 = Deaths_2019/365) %>%
  mutate(Total_Deaths_per_100k_2019 = 100000* Deaths_2019/Pop_Estimate_2019) %>%
  mutate(Deaths_per_100k = 100000*deaths/Pop_Estimate_2019) %>%
  mutate(Total_Deaths_per_100k = 100000*cumulative_deaths/Pop_Estimate_2019) %>%
  mutate(Density_Estimate.2019 = as.numeric(Density_Estimate.2019)) %>%
  mutate(first_death = min(date, na.rm = T)) %>%
  mutate(textx = 0.5*(most_recent_date - first_death) + first_death) %>%
  mutate(textx2 = Sys.Date()-12) %>%
  mutate(texty = 0.8*max_average_deaths) %>%
  mutate(texty2 = 0.8*most_recent_deaths) %>%
  mutate(trajectory = lm(deaths[date>Sys.Date()-14] ~ date[date>Sys.Date()-14])$coef[2])


COVID19Final$state_order <- factor(COVID19Final$state, levels = levels(reorder(COVID19Final$state, -COVID19Final$most_recent_deaths)))
COVID19Final$state_order2 <- factor(COVID19Final$state, levels = levels(reorder(COVID19Final$state, -COVID19Final$trajectory)))

civilwars = round(max(COVID19Final$cumulative_deaths)/620000,2)
```

Total Coronavirus deaths in the US are currently at `r civilwars` US Civil Wars. As the scale of the impact on the United States escapes our intuitive grasp, it is more important than ever to have effective data visualizations of effective metrics. Deaths per day is the best variable we have for realistically assessing Coronavirus within the country. It is a weighted function of the number of cases within a state and the state's ability to address those cases. By looking at this one metric - deaths per day - we can quickly come to an understanding of the levels of crisis in each state.

*Plot of a 7-day moving average of new deaths per day for all 50 states, DC, and a national total. The moving average is used to smooth out spikes in under-reporting on weekends. The number and color for each state refer to the number of deaths for the day on which data is most recently available (`r data_day`).*

```{r preview, echo=FALSE, warning=FALSE, fig.width=10}
ggplotly(
          p = ggplot(data=COVID19Final) +
          geom_line(aes(color = log(most_recent_deaths+1),
                        x=date,y=deaths_weekly_average, 
                        label1 = date, 
                        label2 = deaths, 
                        label3 = Total_Deaths_2019)) + 
          geom_text(aes(color = log(most_recent_deaths+1),
                        x=textx,
                        y=texty,
                        label4 = most_recent_date,
                      label = most_recent_deaths), alpha=1) + 
          scale_colour_gradient(low = "grey", high = "darkred") +
          theme_tufte(ticks = F) +
          theme(axis.title = element_blank(),
                axis.text = element_blank(),
                legend.position = "none",
                panel.spacing.x=unit(0.5, "lines"),
                panel.spacing.y=unit(2, "lines")) +
          labs(title = "Deaths per Day") +
          facet_wrap(~state_order, scales = "free"),
      dynamicTicks = F, tooltip = c("state", "label1", "label2", "label3", "label4"))
```

By reducing the scale to the last 14 days, we can see the current trends of the virus in each area.

*A steep, upward-sloping dashed line would indicate consistent growth in the number of deaths per day, while a horizontal line would indicate that the number of deaths per day is constant. A steep, downward-sloping dashed lines would indicate a consistent decrease in the number of deaths per day. Color still indicates the number of deaths on the most recent day. The ideal image for each state would be a grey, horizontal dashed line - none, or very low deaths on the most recent day, and no growth in deaths over the past 2 weeks.*

```{r preview2, echo=FALSE, warning=FALSE, fig.width=10}
ggplotly(
          p = ggplot(data=subset(COVID19Final, date > Sys.Date()-14)) +
          geom_line(aes(color = log(most_recent_deaths+1),
                        x=date,y=deaths, 
                        label1 = date, 
                        label2 = deaths, 
                        label3 = round(trajectory,1))) + 
          #geom_text(aes(color = log(most_recent_deaths+1),
          #              x=textx2,
          #              y=texty,
          #              label4 = most_recent_date,
          #              label = round(trajectory,0)), alpha=1) + 
          geom_smooth(aes(x=date, y=deaths, color = log(most_recent_deaths+1)), formula = y ~ x, method = "lm", linetype="dashed", se = F, size = .2)+
          scale_colour_gradient(low = "grey", high = "darkred") +
          theme_tufte(ticks = F) +
          theme(axis.title = element_blank(),
                axis.text = element_blank(),
                legend.position = "none",
                panel.spacing.x=unit(0.5, "lines"),
                panel.spacing.y=unit(2, "lines")) +
          labs(title = "Last 14 Days") +
          facet_wrap(~state_order2, scales = "free"),
      dynamicTicks = F, tooltip = c("state", "label1", "label2", "label3", "label4"))
```

I have tried my best to reimagine Coronavirus visualizations in the context of Tufte's advice, and would love to hear what you like, and especially what you don't like, about my efforts. Please contact me at *francisabritschgi@gmail.com* to share whatever feedback or questions you have. 